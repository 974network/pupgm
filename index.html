<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>عدّاد الصلاة — الموقع الحالي</title>
<style>
  :root{--bg:#fff;--card:#fff;--ink:#0e2136;--muted:#6c7b90;--radius:22px}
  *{box-sizing:border-box}
  body{
    margin:0;background:var(--bg);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Kufi Arabic","Noto Sans Arabic",Tahoma,Arial;
    color:var(--ink);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px
  }
  .wrap{max-width:1100px;width:100%;display:grid;gap:28px}
  .card{
    background:var(--card);border-radius:var(--radius);
    padding:28px clamp(22px,4vw,40px);
    box-shadow:0 30px 50px rgba(14,33,54,.12),0 6px 14px rgba(14,33,54,.08);
    border:1px solid rgba(14,33,54,.05)
  }
  .hero{display:flex;align-items:center;justify-content:space-between;gap:24px;flex-wrap:wrap}
  .subtitle{color:var(--muted);font-weight:700;letter-spacing:.3px}
  .next-name{font-size:clamp(24px,2.3vw,30px);font-weight:800}
  .countdown-big{
    font-variant-numeric:tabular-nums;font-weight:900;line-height:1;
    font-size:clamp(44px,9vw,84px);text-shadow:0 6px 18px rgba(14,33,54,.18)
  }
  .meta{color:var(--muted);font-size:12px;text-align:center;margin-top:8px}
  .badge{
    display:inline-block;border:1px solid rgba(14,33,54,.14);
    border-radius:999px;padding:6px 10px;color:var(--muted);font-size:12px
  }
  .btn{
    border:1px solid rgba(14,33,54,.14);border-radius:999px;padding:6px 12px;background:#fff;cursor:pointer;
    font-size:12px;margin-inline-start:8px
  }
  .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .slot{
    background:#fff;border:1px solid rgba(14,33,54,.08);border-radius:16px;padding:16px 18px;
    display:grid;gap:8px;box-shadow:0 10px 20px rgba(14,33,54,.06)
  }
  .slot .name{font-weight:800;font-size:18px}
  .slot .cd{font-variant-numeric:tabular-nums;font-weight:800;font-size:28px;line-height:1.1}
  .is-next{outline:2px solid rgba(14,33,54,.12)}
  .note{color:var(--muted);font-size:12px;text-align:center}
</style>
</head>
<body>
<main class="wrap">
  <!-- البطاقة الرئيسية -->
  <section class="card hero">
    <div>
      <div class="subtitle">الصلاة التالية</div>
      <div id="nextName" class="next-name">—</div>
      <span id="locLabel" class="badge">جارٍ تحديد الموقع…</span>
      <button id="useMyLoc" class="btn" title="إعادة المحاولة لالتقاط موقعك">استخدام موقعي الآن</button>
    </div>
    <div>
      <div id="mainCountdown" class="countdown-big">--:--:--</div>
      <div id="meta" class="meta">—</div>
    </div>
  </section>

  <!-- بطاقات جميع الصلوات -->
  <section class="card">
    <div class="subtitle" style="font-size:18px;margin-bottom:12px">أوقات اليوم — العدّاد لكل صلاة</div>
    <div id="grid" class="grid"></div>
    <div class="note">يتم التحديث تلقائيًا كل منتصف الليل.</div>
  </section>
</main>

<script>
/* ===== الإعدادات ===== */
const METHOD = 13; // Diyanet
const LABELS = {Fajr:"الفجر", Dhuhr:"الظهر", Asr:"العصر", Maghrib:"المغرب", Isha:"العشاء"};
const ORDER  = ['Fajr','Dhuhr','Asr','Maghrib','Isha'];
const FALLBACK = { lat:41.016, lng:28.681, name:"إسطنبول • إسنيورت" };

/* عناصر DOM */
const elMeta=document.getElementById('meta');
const elGrid=document.getElementById('grid');
const elNextName=document.getElementById('nextName');
const elMainCD=document.getElementById('mainCountdown');
const elLoc=document.getElementById('locLabel');
const btnUse=document.getElementById('useMyLoc');

/* حالة التطبيق */
let LAT=FALLBACK.lat, LNG=FALLBACK.lng;
let today={}, tomorrow={}, slots=[], nextIdx=-1;

/* أدوات تنسيق */
const two=n=>String(n).padStart(2,'0');
function fmtHMS(ms){ if(!Number.isFinite(ms) || ms<0) ms=0;
  const s=Math.floor(ms/1000),h=Math.floor(s/3600),m=Math.floor((s%3600)/60),ss=s%60;
  return `${two(h)}:${two(m)}:${two(ss)}`;
}
function ymd(d){ return `${d.getFullYear()}-${two(d.getMonth()+1)}-${two(d.getDate())}`; }

/* تحويل "HH:MM (…)" إلى Date في اليوم المطلوب */
function toDateToday(timeStr, baseDate){
  const hm = timeStr.split(' ')[0]; // ناخذ HH:MM فقط
  const [H,M] = hm.split(':').map(Number);
  const d = new Date(baseDate);
  d.setHours(H, M, 0, 0);
  return d;
}

/* جلب أوقات صلاة ليوم محدّد عبر lat/lng */
async function getTimings(lat, lng, dateObj){
  const url=`https://api.aladhan.com/v1/timings/${ymd(dateObj)}?latitude=${lat}&longitude=${lng}&method=${METHOD}`;
  const r=await fetch(url,{cache:'no-store'});
  const j=await r.json();
  if(j.code!==200) throw new Error('API error');
  const t=j.data.timings;
  return {
    Fajr:    toDateToday(t.Fajr,    dateObj),
    Dhuhr:   toDateToday(t.Dhuhr,   dateObj),
    Asr:     toDateToday(t.Asr,     dateObj),
    Maghrib: toDateToday(t.Maghrib, dateObj),
    Isha:    toDateToday(t.Isha,    dateObj),
  };
}

/* بناء بطاقات الصلوات */
function buildGrid(){
  elGrid.innerHTML=''; slots=[];
  ORDER.forEach(key=>{
    const item=document.createElement('div');
    item.className='slot';
    item.innerHTML=`<div class="name">${LABELS[key]}</div><div class="cd">--:--:--</div>`;
    elGrid.appendChild(item);
    slots.push({key, date:today[key], node:item.querySelector('.cd'), root:item});
  });
}

/* تحديد الصلاة التالية (يعالج ما بعد العشاء بفجر الغد) */
function computeNext(now){
  ORDER.forEach(k=>{ const s=slots.find(x=>x.key===k); s.date=today[k]; });
  nextIdx = slots.findIndex(s=>s.date > now);
  if(nextIdx === -1){ nextIdx = 0; slots[0].date = tomorrow.Fajr; }
  slots.forEach((s,i)=> s.root.classList.toggle('is-next', i===nextIdx));
  elNextName.textContent = LABELS[slots[nextIdx].key];
}

/* حلقة العدّاد */
function tick(){
  const now=new Date();
  slots.forEach(s=> s.node.textContent = fmtHMS(s.date - now));
  if(nextIdx>=0){
    const diff = slots[nextIdx].date - now;
    elMainCD.textContent = fmtHMS(diff);
    if(diff<=0) computeNext(now);
  }
  setTimeout(tick, 1000);
}

/* تحديث عند منتصف الليل */
function scheduleMidnight(){
  const now=new Date(); const midnight=new Date(now); midnight.setHours(24,0,0,0);
  setTimeout(async ()=>{ await init(true); scheduleMidnight(); }, midnight - now + 1000);
}

/* تحديد الموقع (يطلب الإذن على HTTPS/localhost) */
function canAskGeo(){ return location.protocol==='https:' || location.hostname==='localhost'; }
function getBrowserLocation(){
  return new Promise(res=>{
    if(!navigator.geolocation || !canAskGeo()){ res(FALLBACK); return; }
    navigator.geolocation.getCurrentPosition(
      pos=>res({lat:pos.coords.latitude, lng:pos.coords.longitude, name:"موقعي الحالي"}),
      ()=>res(FALLBACK),
      {enableHighAccuracy:true,timeout:8000}
    );
  });
}

/* زر إعادة المحاولة يدويًا */
btnUse.addEventListener('click', async ()=>{
  elLoc.textContent='جارٍ تحديد الموقع…';
  const p = await getBrowserLocation();
  LAT=p.lat; LNG=p.lng; elLoc.textContent=p.name;
  await init(true); // إعادة تحميل الأوقات بالموقع الجديد
});

/* تهيئة */
async function init(force=false){
  try{
    elMeta.textContent = 'جاري جلب أوقات الصلاة…';
    if(!force){ const p = await getBrowserLocation(); LAT=p.lat; LNG=p.lng; elLoc.textContent=p.name; }
    const now = new Date();
    today = await getTimings(LAT, LNG, now);
    const tmr = new Date(now); tmr.setDate(now.getDate()+1);
    tomorrow = await getTimings(LAT, LNG, tmr);

    buildGrid(); computeNext(now);

    const tz = Intl.DateTimeFormat('ar', {timeZoneName:'short'}).format(now).split(' ').pop();
    elMeta.textContent = `المنطقة الزمنية: ${tz} • طريقة: Diyanet`;
  }catch(e){
    console.error(e);
    elMeta.textContent = 'تعذّر جلب الأوقات. حاول التحديث.';
  }
}

/* ابدأ */
init().then(()=>{ tick(); scheduleMidnight(); });
</script>
</body>
</html>
